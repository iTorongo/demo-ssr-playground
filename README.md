## Playground for SSR and Prerendering with Angular

### Installing and building

Install all dependencies as usual.
Just to make sure everything is fine, run the project locally:

```bash
npm install
ng serve
```

If you want, you can take a look at the HTML source code in the browser. It should show the typical `index.html` skeleton with an empty `<app-root></app-root>` element.

We then need separate builds for client and server.

```bash
# Client
ng build --prod

# Server
ng run ssr-playground:server:production --bundleDependencies all


# OR both together
npm run build:client-and-server-bundles
```

You should now find a `dist` folder with two sub-directories:

```
- dist
    - browser
    - server
```

We can take a look at the server now!

### Compiling the server for SSR

The server part is a TypeScript program for Node.js in the `server.ts` file.
In order to bring everything together, we need to bundle the server application using webpack.
Everything is already prepared as NPM run scripts:

```bash
npm run compile:server
```


### Running Server-side rendering

Run the Express server with live server-side rendering:

```bash
node dist/server
```

Open your browser at [http://localhost:4000](http://localhost:4000) to see it in action. When you show the source code in the browser you should see the server-side rendered HTML.


#### Pre-rendering

As for the SSR server, we need to bundle the pre-rendering script `prerender.ts` with Webpack.

```bash
npm run compile:prerender
```

Now run the pre-rendering build that produces static HTML files:

```bash
node dist/prerender
```

You should now find some subfolders in the `dist/browser` directory, according to the routes of the application.
Run a local web server there, e.g. `http-server`:

```bash
cd dist/browser
npx http-server

# OR if you have http-server installed globally
http-server
```

Open your browser at [http://localhost:8080](http://localhost:8080).
This should be blazing fast because it just shows the prerendered pages without doing any rendering at runtime.
The Angular application bundles will kick in later and take over the static page.


## Benchmark (outdated)

**Caution: This was an old demo and doesn't work anymore with newer versions of Angular.**

When doing SSR or pre-rendering the central function is `renderModuleFactory`.
This takes a module factory (generated by the application build) and renders out the HTML.
However, what it does is, it renders one URL and then destroys the application.
When pre-rendering many many pages it comes in handy to keep the applicaion alive without destroying it.

In the `server-utils.ts` file there is a modified version of `renderModuleFactory` which takes the *same* application to render all routes.
This is significantly faster when prerendering a huge number of pages.
However, please note that this is an experiment and not suitable for production without further investigation.

`prerender.benchmark.ts` provides a comparison between both methods:

- Using the normal `renderModuleFactory` that destroys the application after each run
- Using the "hacked" `renderModuleFactoryMany` which keeps the application alive and just changes the route

The benchmark renders 600 pages. You can run it with the following command and see the resulting build times:

```bash
npx ts-node prerender.benchmark
```

A possible output could be the following. You can clearly see that it's much much faster to keep the application alive instead of destroying it. However, this could have some implcations, so please do not use it without knowing what you do.

```
renderRoutesNormal: 3201.249ms
renderRoutesHacked: 9.015ms
```

